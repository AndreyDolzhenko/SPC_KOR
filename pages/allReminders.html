<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</title>
    <link type="Image/x-icon" href="../img/list_992.png" rel="icon" />
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
      }
      h1 {
        color: #333;
        border-bottom: 2px solid #4caf50;
        padding-bottom: 10px;
      }
      .controls {
        margin: 20px 0;
        display: flex;
        gap: 10px;
        align-items: center;
      }
      button {
        background-color: #4caf50;
        color: white;
        border: none;
        padding: 10px 20px;
        cursor: pointer;
        border-radius: 4px;
        font-size: 14px;
      }
      button:hover {
        background-color: #45a049;
      }
      button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }
      .count {
        font-size: 14px;
        color: #666;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      th {
        background-color: #4caf50;
        color: white;
        text-align: left;
        padding: 12px;
        position: sticky;
        top: 0;
      }
      td {
        padding: 10px 12px;
        border-bottom: 1px solid #ddd;
      }
      tr:hover {
        background-color: #f5f5f5;
      }
      .status {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
      }
      .status-–≤-—Ä–∞–±–æ—Ç–µ {
        background-color: #e7f3fe;
        color: #0066cc;
      }
      .status-–≤—ã–ø–æ–ª–Ω–µ–Ω–æ {
        background-color: #e7f7e7;
        color: #2e7d32;
      }
      .status-–æ—Ç–º–µ–Ω–µ–Ω–æ {
        background-color: #fde7e7;
        color: #c62828;
      }
      .loading {
        text-align: center;
        padding: 40px;
        color: #666;
      }
      .error {
        color: #c62828;
        padding: 20px;
        background-color: #ffebee;
        border-radius: 4px;
      }
      .no-data {
        text-align: center;
        padding: 40px;
        color: #666;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <h1>–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</h1>

    <div class="controls">
      <button id="exportBtn" disabled>üìä –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</button>
      <span class="count" id="count">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
    </div>

    <div id="reminders-container">
      <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π...</div>
    </div>

    <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ Excel -->
    <!-- <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
      let remindersData = []; // –ó–¥–µ—Å—å –±—É–¥–µ–º —Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞

      const allReminderList = async () => {
        try {
          const response = await fetch(
            `http://91.236.199.173:3008/api/reminders`
          );

          if (!response.ok) {
            throw new Error(`–û—à–∏–±–∫–∞ HTTP: ${response.status}`);
          }

          const result = await response.json();

          return result;
        } catch (error) {
          console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π:", error);
          throw error;
        }
      };

      function getEmployeeFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get("employee") || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫";
      }

      // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã
      function formatDate(dateString) {
        if (!dateString) return "‚Äî";
        const date = new Date(dateString);
        return date.toLocaleDateString("ru-RU", {
          day: "2-digit",
          month: "2-digit",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      // –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ —Å CSS –∫–ª–∞—Å—Å–æ–º
      function getStatusBadge(status) {
        if (!status) return "‚Äî";
        const className = `status status-${status
          .toLowerCase()
          .replace(/\s+/g, "-")}`;
        return `<span class="${className}">${status}</span>`;
      }

      // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –≤ —Ç–∞–±–ª–∏—Ü–µ
      function displayRemindersTable(reminders) {
        const container = document.getElementById("reminders-container");

        if (!reminders || reminders.length === 0) {
          container.innerHTML =
            '<div class="no-data">–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
          document.getElementById("count").textContent = "–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π: 0";
          return;
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
        document.getElementById(
          "count"
        ).textContent = `–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π: ${reminders.length}`;

        // –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
        const tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>‚Ññ</th>
                            <th>id</th>
                            <th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
                            <th>–ö–ª–∏–µ–Ω—Ç</th>
                            <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–î–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</th>
                            <th>–°–æ–∑–¥–∞–Ω–æ</th>
                            <th>–û–±–Ω–æ–≤–ª–µ–Ω–æ</th>
                        </tr>
                    </thead>
                    <tbody id="reminders-body">
                        ${reminders
                          .map(
                            (reminder, index) => `
                            <tr>
                                <td>${index + 1}</td>
                                <td>
                                    <span class="delete-btn" 
                                          data-id="${reminder.id}"
                                          style="cursor: pointer; color: red; font-size: 18px;">
                                        &#10008;
                                    </span>
                                </td>
                                <td>${getStatusBadge(reminder.employee)}</td>
                                <td><strong>${
                                  reminder.client || "‚Äî"
                                }</strong></td>
                                <td>${reminder.note || "‚Äî"}</td>
                                <td>${getStatusBadge(reminder.status)}</td>
                                <td>${formatDate(reminder.execution_date)}</td>
                                <td>${formatDate(reminder.created_at)}</td>
                                <td>${formatDate(reminder.updated_at)}</td>
                            </tr>
                        `
                          )
                          .join("")}
                    </tbody>
                </table>
            `;

        container.innerHTML = tableHTML;

        // –í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É —ç–∫—Å–ø–æ—Ä—Ç–∞
        document.getElementById("exportBtn").disabled = false;
        
        // ‚≠ê‚≠ê‚≠ê –î–û–ë–ê–í–õ–ï–ù–û: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π ‚≠ê‚≠ê‚≠ê
        console.log("–¢–∞–±–ª–∏—Ü–∞ —Å–æ–∑–¥–∞–Ω–∞, –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è...");
        
        const remindersBody = document.getElementById("reminders-body");
        
        if (remindersBody) {
            console.log("–≠–ª–µ–º–µ–Ω—Ç reminders-body –Ω–∞–π–¥–µ–Ω");
            
            remindersBody.addEventListener("click", (event) => {
                console.log("–ö–ª–∏–∫ –ø–æ —Ç–∞–±–ª–∏—Ü–µ, target:", event.target);
                
                if (event.target.classList.contains("delete-btn")) {
                    const id = event.target.getAttribute("data-id");
                    console.log("–ù–∞–∂–∞–ª–∏ delete-btn —Å id:", id);
                    deleteReminder(id);
                }
            });
            
            console.log("–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ");
        } else {
            console.error("–≠–ª–µ–º–µ–Ω—Ç reminders-body –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã!");
        }
        // ‚≠ê‚≠ê‚≠ê –ö–û–ù–ï–¶ –î–û–ë–ê–í–õ–ï–ù–ù–û–ì–û –ö–û–î–ê ‚≠ê‚≠ê‚≠ê
      }

      async function deleteReminder(id) {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ?")) return;

        try {
          const response = await fetch(
            `http://91.236.199.173:3008/api/reminders/${id}`,
            {
              method: "DELETE",
            }
          );

          if (response.ok) {
            alert("–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ");
            location.reload();
          } else {
            const error = await response.text();
            alert(`–û—à–∏–±–∫–∞: ${error}`);
          }
        } catch (error) {
          console.error("Error:", error);
          alert("–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞");
        }
      }

      // –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
      function exportToExcel(reminders, employeeName) {
        try {
          // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è Excel
          const excelData = reminders.map((reminder, index) => ({
            "‚Ññ": index + 1,
            –ö–ª–∏–µ–Ω—Ç: reminder.client || "",
            –û–ø–∏—Å–∞–Ω–∏–µ: reminder.note || "",
            –°—Ç–∞—Ç—É—Å: reminder.status || "",
            "–î–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è": reminder.execution_date
              ? formatDate(reminder.execution_date)
              : "",
            –°–æ–∑–¥–∞–Ω–æ: reminder.created_at ? formatDate(reminder.created_at) : "",
            –û–±–Ω–æ–≤–ª–µ–Ω–æ: reminder.updated_at
              ? formatDate(reminder.updated_at)
              : "",
            –°–æ—Ç—Ä—É–¥–Ω–∏–∫: reminder.employee || "",
          }));

          // –°–æ–∑–¥–∞–Ω–∏–µ —Ä–∞–±–æ—á–µ–π –∫–Ω–∏–≥–∏
          const worksheet = XLSX.utils.json_to_sheet(excelData);
          const workbook = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(workbook, worksheet, "–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è");

          // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —à–∏—Ä–∏–Ω—ã –∫–æ–ª–æ–Ω–æ–∫
          const colWidths = [
            { wch: 5 }, // ‚Ññ
            { wch: 20 }, // –ö–ª–∏–µ–Ω—Ç
            { wch: 40 }, // –û–ø–∏—Å–∞–Ω–∏–µ
            { wch: 15 }, // –°—Ç–∞—Ç—É—Å
            { wch: 20 }, // –î–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
            { wch: 20 }, // –°–æ–∑–¥–∞–Ω–æ
            { wch: 20 }, // –û–±–Ω–æ–≤–ª–µ–Ω–æ
            { wch: 30 }, // –°–æ—Ç—Ä—É–¥–Ω–∏–∫
          ];
          worksheet["!cols"] = colWidths;

          // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
          const fileName = `–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è_${employeeName}_${new Date()
            .toISOString()
            .slice(0, 10)}.xlsx`;

          // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
          XLSX.writeFile(workbook, fileName);

          console.log(
            `–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${reminders.length} –∑–∞–ø–∏—Å–µ–π –≤ —Ñ–∞–π–ª: ${fileName}`
          );
        } catch (error) {
          console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –≤ Excel:", error);
          alert(
            "–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –≤ Excel. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π."
          );
        }
      }

      // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
      async function loadReminders() {
        document.querySelector("h1").textContent = `–í—Å–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è:`;

        try {
          const reminders = await allReminderList();
          remindersData = reminders; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
          displayRemindersTable(reminders);
        } catch (error) {
          document.getElementById(
            "reminders-container"
          ).innerHTML = `<div class="error">
                        <strong>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:</strong><br>
                        ${error.message}
                    </div>`;
          document.getElementById("count").textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏";
        }
      }

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      document.addEventListener("DOMContentLoaded", () => {
        loadReminders();

        // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞
        document.getElementById("exportBtn").addEventListener("click", () => {
          if (remindersData.length > 0) {
            const employee = getEmployeeFromUrl();
            exportToExcel(remindersData, employee);
          } else {
            alert("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞");
          }
        });
      });

      // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞ (–¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö)
      window.addEventListener("resize", () => {
        const employee = getEmployeeFromUrl();
        if (window.innerWidth < 768) {
          document.querySelector(
            "h1"
          ).textContent = `–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è: ${employee.substring(0, 20)}...`;
        } else {
          document.querySelector(
            "h1"
          ).textContent = `–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞: ${employee}`;
        }
      });

      // –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV (—Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫)
      function exportToCSV(reminders, employeeName) {
        try {
          // –ó–∞–≥–æ–ª–æ–≤–∫–∏ –∫–æ–ª–æ–Ω–æ–∫
          const headers = [
            "‚Ññ",
            "–ö–ª–∏–µ–Ω—Ç",
            "–û–ø–∏—Å–∞–Ω–∏–µ",
            "–°—Ç–∞—Ç—É—Å",
            "–î–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è",
            "–°–æ–∑–¥–∞–Ω–æ",
            "–û–±–Ω–æ–≤–ª–µ–Ω–æ",
            "–°–æ—Ç—Ä—É–¥–Ω–∏–∫",
          ];

          // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
          const rows = reminders.map((reminder, index) => [
            index + 1,
            reminder.client || "",
            reminder.note || "",
            reminder.status || "",
            formatDate(reminder.execution_date),
            formatDate(reminder.created_at),
            formatDate(reminder.updated_at),
            reminder.employee || "",
          ]);

          // –°–æ–∑–¥–∞–Ω–∏–µ CSV –∫–æ–Ω—Ç–µ–Ω—Ç–∞
          const csvContent = [
            headers.join(";"),
            ...rows.map((row) =>
              row
                .map((cell) => {
                  // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –∫–∞–≤—ã—á–∫–∏ –∏ —Ç–æ—á–∫–∏ —Å –∑–∞–ø—è—Ç–æ–π
                  const cellStr = String(cell);
                  if (
                    cellStr.includes(";") ||
                    cellStr.includes('"') ||
                    cellStr.includes("\n")
                  ) {
                    return `"${cellStr.replace(/"/g, '""')}"`;
                  }
                  return cellStr;
                })
                .join(";")
            ),
          ].join("\n");

          // –°–æ–∑–¥–∞–Ω–∏–µ BLOB –∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ
          const blob = new Blob(["\ufeff" + csvContent], {
            type: "text/csv;charset=utf-8;",
          });
          const link = document.createElement("a");

          if (navigator.msSaveBlob) {
            // –î–ª—è IE
            navigator.msSaveBlob(blob, `–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è_${employeeName}.csv`);
          } else {
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute(
              "download",
              `–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è_${employeeName}_${new Date()
                .toISOString()
                .slice(0, 10)}.csv`
            );
            link.style.visibility = "hidden";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          }

          console.log(`–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${reminders.length} –∑–∞–ø–∏—Å–µ–π –≤ CSV`);
        } catch (error) {
          console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –≤ CSV:", error);
          alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ: " + error.message);
        }
      }      
     
</script>
  </body>
</html>
